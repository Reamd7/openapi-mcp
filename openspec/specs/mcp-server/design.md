# 设计: MCP 服务器

## 上下文

MCP 服务器能力负责处理模型上下文协议 (MCP) 通信层，管理 OpenAPI 查询服务器的工具注册和请求路由。

## 目标 / 非目标

**目标**:
- 处理 MCP stdio 协议通信
- 注册和路由 6 个查询工具
- 管理服务器生命周期（初始化、启动、停止）

**非目标**:
- 直接处理 OpenAPI 文档（由 openapi-parser 处理）
- 文档加载（由 openapi-loader 处理）
- 工具实现逻辑（由 mcp-tools 处理）

## 决策

### 决策 1: 使用 @modelcontextprotocol/sdk
选择官方 MCP SDK 进行协议实现。

**理由**:
- 由 MCP 作者维护的官方 SDK
- 自动处理 stdio 通信
- 内置请求/响应解析

**考虑的替代方案**:
- 自定义 stdio 实现: 更多控制但维护更多
- 其他社区库: 不太成熟

### 决策 2: 工具注册表模式
使用集中式工具注册表来管理工具。

**理由**:
- 可用工具的单一真实来源
- 易于添加新工具
- 一致的工具注册

### 决策 3: 服务器配置
服务器使用 OpenAPI 文档源路径初始化。

**理由**:
- 每个服务器实例一个文档
- 通过 CLI 参数简单启动
- 解析文档的清晰所有权

## 架构

```
┌─────────────────────────────────────────┐
│         Claude Desktop (MCP 客户端)     │
└─────────────────┬───────────────────────┘
                  │ JSON-RPC (stdio)
┌─────────────────▼───────────────────────┐
│           MCP Server                     │
│  ┌────────────────────────────────────┐ │
│  │      工具注册表                    │ │
│  │  - get_api_info                   │ │
│  │  - list_endpoints                 │ │
│  │  - search_endpoints               │ │
│  │  - get_endpoint_details           │ │
│  │  - list_schemas                   │ │
│  │  - get_schema_details             │ │
│  └────────────────────────────────────┘ │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│         OpenAPIParser                   │
│  (文档解析和查询)                        │
└─────────────────────────────────────────┘
```

## 数据流

**初始化**:
1. 服务器使用 spec_path 参数启动
2. OpenAPILoader 加载文档
3. OpenAPIParser 解析和索引
4. 工具使用解析器引用注册
5. 服务器开始在 stdio 上监听

**工具调用**:
1. 客户端发送 `tools/call` 请求
2. 服务器路由到相应的工具处理程序
3. 工具查询 OpenAPIParser
4. 结果格式化并返回

## 错误处理

- **无效源**: 初始化期间返回错误
- **无效工具调用**: 返回 MCP 错误响应
- **工具执行错误**: 捕获并返回错误消息
- **协议错误**: 返回 JSON-RPC 错误响应

## 外部依赖

| 包 | 版本 | 用途 |
|---------|---------|---------|
| @modelcontextprotocol/sdk | ^1.25.1 | MCP 协议实现 |

## 相关能力

- **openapi-loader**: 在服务器初始化之前加载文档
- **openapi-parser**: 为工具提供查询功能
- **mcp-tools**: 实现 6 个查询工具
